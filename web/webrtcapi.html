<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC webcam</title>
    <style>
    button {
        padding: 8px 16px;
    }

    video {
        width: 100%;
    }

    .option {
        margin-bottom: 8px;
    }

    #media {
        max-width: 1280px;
    }
    </style>
</head>
<body>

<div class="option">
    <input id="use-stun" type="checkbox"/>
    <label for="use-stun">Use STUN server</label>
</div>
<button id="start" onclick="start()">Start</button>
<button id="stop" style="display: none" onclick="stop()">Stop</button>
<button class="btn btn-primary" id="btn_start_record">Start Recording</button>
<button class="btn btn-primary" id="btn_stop_record" disabled>Stop Recording</button>
<!-- <button class="btn btn-primary" id="btn_download">Download Video</button> -->
<input type="hidden" id="sessionid" value="0">

<div id="media">
    <h2>Media</h2>

    <audio id="audio" autoplay="true"></audio>
    <video id="video" style="width:600px;" autoplay="true" playsinline="true"></video>
</div>

<script src="client.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
</body>
<script type="text/javascript" charset="utf-8">

	$(document).ready(function() {
	  // var host = window.location.hostname
	  // var ws = new WebSocket("ws://"+host+":8000/humanecho");
	  // //document.getElementsByTagName("video")[0].setAttribute("src", aa["video"]);
	  // ws.onopen = function() {
		// console.log('Connected');
	  // };
	  // ws.onmessage = function(e) {
		// console.log('Received: ' + e.data);
		// data = e
		// var vid = JSON.parse(data.data); 
		// console.log(typeof(vid),vid)
		// //document.getElementsByTagName("video")[0].setAttribute("src", vid["video"]);
		
	  // };
	  // ws.onclose = function(e) {
		// console.log('Closed');
	  // };

	  // Microphone audio recording variables
	  var mediaRecorder = null;
	  var audioChunks = [];
	  var audioStream = null;
	  var currentMimeType = 'audio/webm';

	  // Function to convert audio blob to WAV format
	  function convertToWav(audioBlob) {
		  return new Promise(function(resolve, reject) {
			  const reader = new FileReader();
			  reader.onload = function(e) {
				  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
				  audioContext.decodeAudioData(e.target.result)
					  .then(function(audioBuffer) {
						  // Convert AudioBuffer to WAV
						  const wav = audioBufferToWav(audioBuffer);
						  const wavBlob = new Blob([wav], { type: 'audio/wav' });
						  resolve(wavBlob);
					  })
					  .catch(function(error) {
						  reject(error);
					  });
			  };
			  reader.onerror = reject;
			  reader.readAsArrayBuffer(audioBlob);
		  });
	  }

	  // Function to convert AudioBuffer to WAV format
	  function audioBufferToWav(buffer) {
		  const length = buffer.length;
		  const numberOfChannels = buffer.numberOfChannels;
		  const sampleRate = buffer.sampleRate;
		  const arrayBuffer = new ArrayBuffer(44 + length * numberOfChannels * 2);
		  const view = new DataView(arrayBuffer);
		  const channels = [];
		  let offset = 0;
		  let pos = 0;

		  // Write WAV header
		  const setUint16 = function(data) {
			  view.setUint16(pos, data, true);
			  pos += 2;
		  };
		  const setUint32 = function(data) {
			  view.setUint32(pos, data, true);
			  pos += 4;
		  };

		  // RIFF identifier
		  setUint32(0x46464952); // "RIFF"
		  // File length
		  setUint32(36 + length * numberOfChannels * 2);
		  // RIFF type
		  setUint32(0x45564157); // "WAVE"
		  // Format chunk identifier
		  setUint32(0x20746d66); // "fmt "
		  // Format chunk length
		  setUint32(16);
		  // Sample format (raw)
		  setUint16(1);
		  // Channel count
		  setUint16(numberOfChannels);
		  // Sample rate
		  setUint32(sampleRate);
		  // Byte rate (sample rate * block align)
		  setUint32(sampleRate * numberOfChannels * 2);
		  // Block align (channel count * bytes per sample)
		  setUint16(numberOfChannels * 2);
		  // Bits per sample
		  setUint16(16);
		  // Data chunk identifier
		  setUint32(0x61746164); // "data"
		  // Data chunk length
		  setUint32(length * numberOfChannels * 2);

		  // Get channel data
		  for (let i = 0; i < numberOfChannels; i++) {
			  channels.push(buffer.getChannelData(i));
		  }

		  // Interleave and convert to 16-bit PCM
		  const samples = new Int16Array(length * numberOfChannels);
		  for (let i = 0; i < length; i++) {
			  for (let channel = 0; channel < numberOfChannels; channel++) {
				  const sample = Math.max(-1, Math.min(1, channels[channel][i]));
				  samples[i * numberOfChannels + channel] = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
			  }
		  }

		  // Write samples to the buffer after the header (at offset 44)
		  const samplesView = new Int16Array(arrayBuffer, 44);
		  samplesView.set(samples);

		  return arrayBuffer;
	  }

	  $('#echo-form').on('submit', function(e) {
      e.preventDefault();
      var message = $('#message').val();
      console.log('Sending: ' + message);
      console.log('sessionid: ',document.getElementById('sessionid').value);
      fetch('/human', {
            body: JSON.stringify({
                text: message,
                type: 'echo',
                interrupt: true,
                sessionid:parseInt(document.getElementById('sessionid').value),
            }),
            headers: {
                'Content-Type': 'application/json'
            },
            method: 'POST'
      });
      //ws.send(message);
      $('#message').val('');
	  });

    $('#btn_start_record').click(function() {
        // 开始录制
        console.log('Starting recording...');
        
        // Start server-side recording
        fetch('/record', {
            body: JSON.stringify({
                    type: 'start_record',
                    sessionid:parseInt(document.getElementById('sessionid').value),
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
            method: 'POST'
        }).then(function(response) {
            if (response.ok) {
                console.log('Server recording started.');
            } else {
                console.error('Failed to start server recording.');
            }
        }).catch(function(error) {
            console.error('Error starting server recording:', error);
        });

        // Start microphone audio recording
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(function(stream) {
                audioChunks = [];
                audioStream = stream;

                // Detect supported audio format
                currentMimeType = 'audio/webm';
                if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                    currentMimeType = 'audio/webm;codecs=opus';
                } else if (MediaRecorder.isTypeSupported('audio/webm')) {
                    currentMimeType = 'audio/webm';
                } else if (MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')) {
                    currentMimeType = 'audio/ogg;codecs=opus';
                }

                console.log('Using audio format:', currentMimeType);
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: currentMimeType
                });

                mediaRecorder.ondataavailable = function(e) {
                    if (e.data.size > 0) {
                        audioChunks.push(e.data);
                    }
                };

                // Request data every 100ms to ensure timely collection
                mediaRecorder.start(100);
                console.log('Microphone recording started.');
                
                $('#btn_start_record').prop('disabled', true);
                $('#btn_stop_record').prop('disabled', false);
            })
            .catch(function(error) {
                console.error('Cannot access microphone:', error);
                alert('Cannot access microphone. Please check browser permissions.');
                // Still enable stop button in case server recording started
                $('#btn_start_record').prop('disabled', true);
                $('#btn_stop_record').prop('disabled', false);
            });
    });

    $('#btn_stop_record').click(function() {
        // 结束录制
        console.log('Stopping recording...');
        
        // Stop server-side recording
        fetch('/record', {
            body: JSON.stringify({
                    type: 'end_record',
                    sessionid:parseInt(document.getElementById('sessionid').value),
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
            method: 'POST'
        }).then(function(response) {
            if (response.ok) {
                console.log('Server recording stopped.');
            } else {
                console.error('Failed to stop server recording.');
            }
        }).catch(function(error) {
            console.error('Error stopping server recording:', error);
        });

        // Stop microphone audio recording and send to server
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            
            // Set stop handler to send audio when recording stops
            mediaRecorder.onstop = function() {
                // Combine audio chunks into Blob
                const audioBlob = new Blob(audioChunks, { type: currentMimeType });

                // Convert to WAV format (soundfile library supports WAV)
                convertToWav(audioBlob).then(function(wavBlob) {
                    // Send audio to server
                    if (wavBlob.size > 0) {
                        const formData = new FormData();
                        formData.append('file', wavBlob, 'recording.wav');
                        formData.append('sessionid', document.getElementById('sessionid').value);

                        console.log('Sending audio to /humanaudio, size:', wavBlob.size);

                        fetch('/humanaudio', {
                            method: 'POST',
                            body: formData
                        }).then(function(response) {
                            return response.json();
                        }).then(function(data) {
                            if (data.code === 0) {
                                console.log('Audio sent successfully to /humanaudio');
                            } else {
                                console.error('Failed to send audio:', data.msg);
                            }
                        }).catch(function(error) {
                            console.error('Error sending audio:', error);
                        });
                    }

                    // Clear audio chunks
                    audioChunks = [];
                }).catch(function(error) {
                    console.error('Error converting audio to WAV:', error);
                    // Clear audio chunks even on error
                    audioChunks = [];
                });
            };
        }

        // Stop all audio tracks
        if (audioStream) {
            audioStream.getTracks().forEach(track => track.stop());
            audioStream = null;
        }

        $('#btn_start_record').prop('disabled', false);
        $('#btn_stop_record').prop('disabled', true);
    });

    // $('#btn_download').click(function() {
    //     // 下载视频文件
    //     console.log('Downloading video...');
    //     fetch('/record_lasted.mp4', {
    //         method: 'GET'
    //     }).then(function(response) {
    //         if (response.ok) {
    //             return response.blob();
    //         } else {
    //             throw new Error('Failed to download the video.');
    //         }
    //     }).then(function(blob) {
    //         // 创建一个 Blob 对象
    //         const url = window.URL.createObjectURL(blob);
    //         // 创建一个隐藏的可下载链接
    //         const a = document.createElement('a');
    //         a.style.display = 'none';
    //         a.href = url;
    //         a.download = 'record_lasted.mp4';
    //         document.body.appendChild(a);
    //         // 触发下载
    //         a.click();
    //         // 清理
    //         window.URL.revokeObjectURL(url);
    //         document.body.removeChild(a);
    //         console.log('Video downloaded successfully.');
    //     }).catch(function(error) {
    //         console.error('Error:', error);
    //     });
    // });

	});

  
</script>
</html>
